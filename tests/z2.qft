/* Adapted from: */
/* Z_2 lattice gauge simulation */
/* Michael Creutz <creutz@bnl.gov>     */
/* http://thy.phy.bnl.gov/~creutz/z2.c */

extern int rand();
extern int srand(unsigned int seed);
extern int printf(const char* fmt, ..);
extern double exp(double e);


/* the lattice is of dimensions SIZE**4  */
const int SIZE = 10;
typedef int field(5) Links; // Last index is link direction
int field(5) link;

void moveup(int matrix(5) *x, int d)
{
	x(d) += 1;
	if (x(d) >= SIZE) x(d) -= SIZE; 
}

void movedown(int matrix(5) *x, int d)
{
	x(d) -= 1;
	if (x(d) < 0) x(d) += SIZE;
}

void coldstart()
{
	for_field(link; link) {
		link(id(0), id(1), id(2), id(3), id(4)) = 1;
	}
}

double quasirand(uint64_t ix)
{
	return (ix*2011 % 137)/137.0; // @todo Better generator
}

double update(double beta, int iter)
{
	float action = 0.0; 

	for_field(link; link; oddeven) {
		int dperp;
		float staplesum = 0;
		int staple;
		float bplus;
		float bminus;

		int d = id(4);
		for (dperp = 0; dperp < 4; dperp += 1) {
			if (dperp != d) {
				movedown(&id, dperp);
				int v1 = link(id(0), id(1), id(2), id(3), dperp);
				int v2 = link(id(0), id(1), id(2), id(3), d);
				staple = v1*v2;
				moveup(&id, d);
				staple *= link(id(0), id(1), id(2), id(3), dperp);
				moveup(&id, dperp);
				staplesum += staple;

				staple = link(id(0), id(1), id(2), id(3), dperp);
				moveup(&id, dperp);
				movedown(&id, d);
				staple *= link(id(0), id(1), id(2), id(3), d);
				movedown(&id, dperp);
				staple *= link(id(0), id(1), id(2), id(3), dperp);
				staplesum += staple;
			}
		}

		bplus = exp(beta*staplesum);
		bminus = 1/bplus;
		bplus = bplus/(bplus+bminus);

		if (quasirand(id(0) + id(1)*SIZE + id(3)*SIZE*SIZE + id(4)*SIZE*SIZE*SIZE + iter*SIZE*SIZE*SIZE*SIZE) < bplus) {
			link(id(0), id(1), id(2), id(3), d) = 1;
			action += staplesum;
		} else {
			link(id(0), id(1), id(2), id(3), d) = -1;
			action -= staplesum;
		}
	}

	action /= SIZE*SIZE*SIZE*SIZE*4*6;
	return 1.0 - action;
}

int main()
{
	link = alloc_device_field(SIZE, SIZE, SIZE, SIZE, 4);

	double beta;
	double action;
	double dbeta = 0.01;

	coldstart();

	int iter = 0;
	for (beta = 1; beta > 0.0; beta -= dbeta) {
		action = update(beta, iter);
		printf("%g\t%g\n", beta, action); 
		++iter;
	}
	printf("\n\n");
	for (beta = 0; beta < 1.0; beta += dbeta) {
		action = update(beta, iter);
		printf("%g\t%g\n", beta, action); 
		++iter;
	}

	free_device_field(link);

	return 0;
}

